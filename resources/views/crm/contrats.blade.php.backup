<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSI AFRICA - Signature √âlectronique Automatis√©e</title>
    <!-- Bootstrap CDN removed to avoid conflicts with CRM - use CRM's existing Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <!-- Bootstrap 5 CDN (minimal, for this page only) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --psi-blue: #0A2463;
            --psi-gold: #D4AF37;
            --psi-light: #F8F9FA;
            --psi-dark: #1A1A1A;
            --primary: #2563eb;
            --bg-secondary: #f8fafc;
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f8fafc 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .navbar-psi {
            background: var(--psi-blue) !important;
            border-bottom: 3px solid var(--psi-gold);
        }
        
        .logo-container {
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-right: 15px;
        }
        
        .card-psi {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(10, 36, 99, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card-psi:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(10, 36, 99, 0.15);
        }
        
        .btn-psi-primary {
            background: var(--psi-blue);
            border-color: var(--psi-blue);
            color: white;
            font-weight: 600;
            padding: 10px 25px;
            border-radius: 8px;
        }
        
        .btn-psi-primary:hover {
            background: #08318a;
            border-color: #08318a;
            transform: translateY(-2px);
        }
        
        .btn-psi-secondary {
            background: var(--psi-gold);
            border-color: var(--psi-gold);
            color: var(--psi-dark);
            font-weight: 600;
            padding: 10px 25px;
            border-radius: 8px;
        }
        
        .btn-psi-secondary:hover {
            background: #c19b2c;
            border-color: #c19b2c;
            transform: translateY(-2px);
        }
        
        .signature-pad {
            border: 2px dashed #dee2e6;
            background: #f8f9fa;
            cursor: crosshair;
            border-radius: 8px;
            width: 100%;
        }
        
        .contrat-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 4px solid var(--psi-gold);
        }
        
        .section {
            display: none;
        }
        
        .active-section {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            color: white;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0;
        }
        
        .badge-psi {
            background: var(--psi-gold);
            color: var(--psi-dark);
            font-weight: 600;
        }
        
        .audit-log {
            border-left: 3px solid var(--psi-blue);
            background: #f8fbff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-control:focus {
            border-color: var(--psi-blue);
            box-shadow: 0 0 0 0.2rem rgba(10, 36, 99, 0.25);
        }
        
        .progress-bar-psi {
            background: var(--psi-blue);
        }
        
        .montant-lettres {
            font-style: italic;
            color: var(--psi-blue);
            font-weight: 500;
        }
        
        .pdf-preview {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            min-height: 500px;
            background: white;
            padding: 20px;
            overflow: auto;
        }
        
        .fiche-field {
            border-bottom: 1px dashed #ccc;
            min-height: 25px;
            margin-bottom: 5px;
            padding: 2px 5px;
        }
        
        .mode-paiement {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .echeance-date {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .contrat-content {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
        }
        
        .contrat-article {
            margin-bottom: 20px;
        }
        
        .contrat-article h4 {
            color: #0A2463;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        /* Alignement avec le CRM principal - m√™me largeur de container */
        .container {
            max-width: 1400px !important;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .container {
                max-width: 100% !important;
                padding: 1rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <!-- Tableau de Bord Agent -->
        <div id="dashboard" class="section active-section">
            <div class="row mb-4">
                <div class="col-md-8">
                    <h2 class="fw-bold" style="color: var(--psi-blue);">
                        <i class="bi bi-speedometer2"></i> Tableau de Bord Agent
                    </h2>
                    <p class="lead">Gestion des contrats et fiches d'inscription</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-psi-primary me-2" onclick="showSection('nouveau-contrat')">
                        <i class="bi bi-plus-circle"></i> Nouveau Contrat
                    </button>
                    <button class="btn btn-psi-secondary" onclick="showSection('nouvelle-fiche')">
                        <i class="bi bi-person-plus"></i> Nouvelle Fiche
                    </button>
                </div>
            </div>

            <!-- Cartes Statistiques -->
            <div class="row mb-5">
                <div class="col-md-3 mb-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--psi-blue), #1a3a8a);">
                        <div class="stat-number" id="stat-total">0</div>
                        <div>Contrats Cr√©√©s</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745, #20c997);">
                        <div class="stat-number" id="stat-signes">0</div>
                        <div>Contrats Sign√©s</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #ffc107, #fd7e14);">
                        <div class="stat-number" id="stat-fiches">0</div>
                        <div>Fiches Cr√©√©es</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #6f42c1, #e83e8c);">
                        <div class="stat-number" id="stat-expires">0</div>
                        <div>Expir√©s</div>
                    </div>
                </div>
            </div>

            <!-- Actions Rapides -->
            <div class="row">
                <div class="col-md-8">
                    <div class="card card-psi mb-4">
                        <div class="card-header bg-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-lightning-charge"></i> Actions Rapides
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-psi-primary btn-lg" onclick="showSection('nouveau-contrat')">
                                            <i class="bi bi-file-earmark-plus"></i><br>
                                            <small>Cr√©er un Contrat</small>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary btn-lg" onclick="showSection('liste-contrats')">
                                            <i class="bi bi-list-check"></i><br>
                                            <small>G√©rer les Contrats</small>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-psi-secondary btn-lg" onclick="showSection('nouvelle-fiche')">
                                            <i class="bi bi-person-plus"></i><br>
                                            <small>Nouvelle Fiche</small>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Mini Stats -->
                            <div class="row mt-3 text-center">
                                <div class="col-md-4">
                                    <div class="p-2 bg-light rounded">
                                        <h4 class="mb-0 text-primary" id="quick-stat-total">0</h4>
                                        <small class="text-muted">Total Contrats</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-2 bg-light rounded">
                                        <h4 class="mb-0 text-success" id="quick-stat-signes">0</h4>
                                        <small class="text-muted">Sign√©s</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-2 bg-light rounded">
                                        <h4 class="mb-0 text-warning" id="quick-stat-attente">0</h4>
                                        <small class="text-muted">En Attente</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Derni√®res Activit√©s -->
                    <div class="card card-psi">
                        <div class="card-header bg-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-clock-history"></i> Derni√®res Activit√©s
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="audit-logs">
                                <div class="text-center text-muted py-3">
                                    <i class="bi bi-inbox"></i><br>
                                    Aucune activit√© r√©cente
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- Guide Rapide -->
                    <div class="card card-psi mb-4">
                        <div class="card-header bg-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-info-circle"></i> Guide du Processus
                            </h5>
                        </div>
                        <div class="card-body">
                            <ol class="list-group list-group-flush">
                                <li class="list-group-item px-0">
                                    <strong>1. Cr√©ation</strong><br>
                                    Contrat ou fiche d'inscription
                                </li>
                                <li class="list-group-item px-0">
                                    <strong>2. Validation</strong><br>
                                    Contr√¥le et g√©n√©ration du PDF
                                </li>
                                <li class="list-group-item px-0">
                                    <strong>3. Envoi</strong><br>
                                    Lien unique envoy√© au candidat
                                </li>
                                <li class="list-group-item px-0">
                                    <strong>4. Signature</strong><br>
                                    Le candidat signe √©lectroniquement
                                </li>
                                <li class="list-group-item px-0">
                                    <strong>5. Archivage</strong><br>
                                    PDF sign√© verrouill√© et sauvegard√©
                                </li>
                            </ol>
                        </div>
                    </div>

                    <!-- Statistiques de Performance -->
                    <div class="card card-psi">
                        <div class="card-header bg-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-graph-up"></i> Performance
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Taux de signature</span>
                                    <span id="taux-signature">0%</span>
                                </div>
                                <div class="progress mt-1">
                                    <div class="progress-bar progress-bar-psi" id="progress-signature" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Fiches compl√©t√©es</span>
                                    <span id="taux-fiches">0%</span>
                                </div>
                                <div class="progress mt-1">
                                    <div class="progress-bar bg-success" id="progress-fiches" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulaire Nouveau Contrat -->
        <div id="nouveau-contrat" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold" style="color: var(--psi-blue);">
                    <i class="bi bi-file-earmark-plus"></i> Nouveau Contrat d'Assistance Visa
                </h2>
                <button class="btn btn-outline-secondary" onclick="showSection('dashboard')">
                    <i class="bi bi-arrow-left"></i> Retour
                </button>
            </div>

            <form id="form-contrat" onsubmit="creerContrat(event)">
                <div class="card card-psi">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">Informations du Candidat</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nom du Candidat *</label>
                                    <input type="text" class="form-control" name="nom" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Pr√©nom du Candidat *</label>
                                    <input type="text" class="form-control" name="prenom" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Date de Naissance *</label>
                                    <input type="date" class="form-control" name="date_naissance" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Lieu de Naissance *</label>
                                    <input type="text" class="form-control" name="lieu_naissance" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Profession *</label>
                                    <input type="text" class="form-control" name="profession" required>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">T√©l√©phone *</label>
                                    <input type="tel" class="form-control" name="telephone" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Email *</label>
                                    <input type="email" class="form-control" name="email" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">N¬∞ CNI/Passeport *</label>
                                    <input type="text" class="form-control" name="numero_cni" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Adresse Compl√®te *</label>
                                    <textarea class="form-control" name="adresse" rows="2" required></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card card-psi mt-4">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">D√©tails du Visa et Conditions Financi√®res</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Destination Visa *</label>
                                    <select class="form-select" name="destination_visa" required>
                                        <option value="Canada">Canada</option>
                                        <option value="France">France</option>
                                        <option value="USA">√âtats-Unis</option>
                                        <option value="Royaume-Uni">Royaume-Uni</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Type de Visa *</label>
                                    <select class="form-select" name="type_visa" required>
                                        <option value="Etudiant">√âtudiant</option>
                                        <option value="Tourisme">Tourisme</option>
                                        <option value="Affaires">Affaires</option>
                                        <option value="Immigration">Immigration</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Montant Total (FCFA) *</label>
                                    <input type="number" class="form-control" name="montant_total" id="montant-total" required onchange="calculerMontants()">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Mode de Paiement *</label>
                                    <select class="form-select" name="mode_paiement" id="mode-paiement-select" required onchange="toggleEchelonnage()">
                                        <option value="avance-solde">50% √† la signature + 50% sous 45 jours</option>
                                        <option value="totalite">Paiement en totalit√©</option>
                                        <option value="echelonnage">√âchelonnage (45 jours apr√®s 1er versement)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div id="section-avance-solde">
                                    <div class="mb-3">
                                        <label class="form-label">Avance Vers√©e *</label>
                                        <input type="number" class="form-control" name="avance" id="avance-input" placeholder="Montant vers√© par le client" onchange="calculerMontants()">
                                        <small class="text-muted">Le montant que le client a d√©j√† vers√©</small>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Reste √† Payer (50%)</label>
                                        <input type="text" class="form-control" id="reste-payer" readonly>
                                        <div class="echeance-date" id="date-echeance-solde"></div>
                                    </div>
                                </div>

                                <div id="section-echelonnage" style="display: none;">
                                    <div class="mode-paiement">
                                        <h6>√âch√©ancier de paiement :</h6>
                                        <div class="mb-2">
                                            <label>1er versement (50%) :</label>
                                            <input type="text" class="form-control" id="versement1" readonly>
                                            <div class="echeance-date">√Ä la signature du contrat</div>
                                        </div>
                                        <div class="mb-2">
                                            <label>2√®me versement (50%) :</label>
                                            <input type="text" class="form-control" id="versement2" readonly>
                                            <div class="echeance-date" id="date-echeance-echelonnage"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Montant en Lettres</label>
                                    <input type="text" class="form-control montant-lettres" id="montant-lettres" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Nom du Conseiller *</label>
                            <input type="text" class="form-control" name="conseiller" value="{{ Auth::user()->name }}" required readonly>
                            <small class="text-muted">Conseiller automatiquement d√©fini</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Lieu du Contrat *</label>
                            <input type="text" class="form-control" name="lieu_contrat" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Date du Contrat *</label>
                            <input type="date" class="form-control" name="date_contrat" id="date-contrat" required onchange="calculerEcheances()">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Observations</label>
                            <textarea class="form-control" name="observations" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-primary" onclick="afficherApercuContrat()">
                        <i class="bi bi-eye"></i> Aper√ßu du Contrat
                    </button>
                    <div>
                        <button type="button" class="btn btn-secondary me-2" onclick="showSection('dashboard')">Annuler</button>
                        <button type="submit" class="btn btn-psi-primary">
                            <i class="bi bi-send-check"></i> Valider et Envoyer le Lien de Signature
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Aper√ßu du Contrat -->
        <div id="apercu-contrat" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold" style="color: var(--psi-blue);">
                    <i class="bi bi-eye"></i> Aper√ßu du Contrat
                </h2>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="showSection('nouveau-contrat')">
                        <i class="bi bi-arrow-left"></i> Retour
                    </button>
                    <button class="btn btn-psi-primary" onclick="window.print()">
                        <i class="bi bi-printer"></i> Imprimer
                    </button>
                </div>
            </div>

            <div class="card card-psi">
                <div class="card-body pdf-preview" id="apercu-contenu">
                    <!-- Contenu g√©n√©r√© dynamiquement -->
                </div>
            </div>
        </div>

        <!-- Lien de Signature G√©n√©r√© -->
        <div id="lien-signature" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold" style="color: var(--psi-blue);">
                    <i class="bi bi-link-45deg"></i> Lien de Signature G√©n√©r√©
                </h2>
                <button class="btn btn-outline-secondary" onclick="showSection('dashboard')">
                    <i class="bi bi-arrow-left"></i> Tableau de Bord
                </button>
            </div>

            <div class="card card-psi">
                <div class="card-body text-center py-5">
                    <div class="mb-4">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h3 class="text-success mb-3">‚úÖ Contrat cr√©√© avec succ√®s !</h3>
                    <p class="lead mb-4">Le lien de signature a √©t√© g√©n√©r√©. Vous pouvez maintenant l'envoyer au candidat.</p>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold">Lien de signature unique et temporaire :</label>
                        <div class="input-group input-group-lg">
                            <input type="text" class="form-control" id="lien-signature-input" readonly>
                            <button class="btn btn-psi-primary" type="button" onclick="copierLien()">
                                <i class="bi bi-clipboard"></i> Copier
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-clock"></i> Ce lien expirera dans 1 heure ou apr√®s signature
                        </div>
                    </div>
                    
                    <div class="alert alert-info text-start">
                        <h6><i class="bi bi-chat-dots"></i> Message √† envoyer au candidat :</h6>
                        <p id="message-sms" class="mb-0"></p>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-outline-primary btn-lg" onclick="showSection('dashboard')">
                            <i class="bi bi-house"></i> Retour au Tableau de Bord
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page de Signature Candidat -->
        <div id="page-signature" class="section">
            <div class="card card-psi">
                <div class="card-header bg-white text-center py-4">
                    <h2 class="mb-2" style="color: var(--psi-blue);">
                        <i class="bi bi-pen"></i> Signature du Contrat
                    </h2>
                    <p class="text-muted mb-0">Veuillez lire attentivement puis signer votre contrat</p>
                </div>
                <div class="card-body">
                    <div class="contrat-container p-4 mb-4">
                        <div id="contrat-a-signer">
                            <!-- Contenu g√©n√©r√© dynamiquement -->
                        </div>
                    </div>

                    <div class="border-top pt-4">
                        <h5 class="mb-4" style="color: var(--psi-blue);">
                            <i class="bi bi-check-square"></i> Validation et Signature
                        </h5>
                        
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="acceptation">
                                <label class="form-check-label fw-bold">
                                    Je reconnais avoir lu et accept√© l'int√©gralit√© des termes de ce contrat
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Nom complet du signataire *</label>
                            <input type="text" class="form-control" id="nom-signataire" placeholder="Votre nom complet">
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Signature √©lectronique *</label>
                            <div class="text-center">
                                <canvas id="signature-pad" class="signature-pad" width="600" height="200"></canvas>
                            </div>
                            <div class="text-center mt-2">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="effacerSignature()">
                                    <i class="bi bi-eraser"></i> Effacer la signature
                                </button>
                            </div>
                        </div>

                        <div class="alert alert-warning">
                            <strong><i class="bi bi-exclamation-triangle"></i> Important :</strong> 
                            Cette signature a valeur l√©gale. Le contrat sera verrouill√© apr√®s signature et ne pourra plus √™tre modifi√©.
                        </div>

                        <div class="text-center">
                            <button class="btn btn-psi-primary btn-lg px-5" onclick="signerContrat()" id="btn-signer">
                                <i class="bi bi-check-lg"></i> Signer et Valider le Contrat
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Signature -->
        <div id="confirmation-signature" class="section">
            <div class="card card-psi text-center py-5">
                <div class="card-body">
                    <div class="mb-4">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                    </div>
                    <h2 class="text-success mb-3">üéâ F√©licitations !</h2>
                    <h4 id="confirmation-nom" class="mb-4">Votre contrat a √©t√© sign√© avec succ√®s.</h4>
                    
                    <div class="alert alert-success d-inline-block text-start">
                        <h6><i class="bi bi-file-earmark-pdf"></i> Votre contrat sign√© est pr√™t :</h6>
                        <p class="mb-2" id="lien-pdf-text"></p>
                        <button class="btn btn-psi-secondary mt-2" onclick="telechargerPDF()">
                            <i class="bi bi-download"></i> T√©l√©charger le PDF Sign√©
                        </button>
                    </div>
                    
                    <div class="mt-5">
                        <p class="text-muted">
                            <i class="bi bi-shield-check"></i> 
                            Document horodat√© et verrouill√© - PSI AFRICA ¬© 2024
                        </p>
                        <button class="btn btn-outline-primary" onclick="showSection('dashboard')">
                            <i class="bi bi-house"></i> Retour √† l'accueil
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste des Contrats -->
        <div id="liste-contrats" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold" style="color: var(--psi-blue);">
                    <i class="bi bi-list-ul"></i> Gestion des Contrats
                </h2>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="showSection('dashboard')">
                        <i class="bi bi-arrow-left"></i> Retour
                    </button>
                    <button class="btn btn-psi-primary" onclick="showSection('nouveau-contrat')">
                        <i class="bi bi-plus-circle"></i> Nouveau Contrat
                    </button>
                </div>
            </div>

            <!-- Filtres et Recherche -->
            <div class="card card-psi mb-3">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-search"></i> Rechercher</label>
                            <input type="text" class="form-control" id="search-contrats" placeholder="Num√©ro, nom, pr√©nom, destination..." onkeyup="filterContrats()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label"><i class="bi bi-filter"></i> Statut</label>
                            <select class="form-select" id="filter-statut" onchange="filterContrats()">
                                <option value="tous">Tous</option>
                                <option value="Sign√©">Sign√©s</option>
                                <option value="En attente">En attente</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                <i class="bi bi-arrow-clockwise"></i> R√©initialiser
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card card-psi">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>N¬∞ Contrat</th>
                                    <th>Candidat</th>
                                    <th>Destination</th>
                                    <th>Montant</th>
                                    <th>Statut</th>
                                    <th>Date Cr√©ation</th>
                                    <th class="text-center" style="width: 280px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-contrats">
                                <!-- Rempli dynamiquement -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination si n√©cessaire -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <small class="text-muted">Total: <strong id="total-contrats-count">0</strong> contrat(s)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulaire Nouvelle Fiche d'Inscription -->
        <div id="nouvelle-fiche" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold" style="color: var(--psi-blue);">
                    <i class="bi bi-person-plus"></i> Nouvelle Fiche d'Inscription
                </h2>
                <button class="btn btn-outline-secondary" onclick="showSection('dashboard')">
                    <i class="bi bi-arrow-left"></i> Retour
                </button>
            </div>

            <form id="form-fiche" onsubmit="creerFicheInscription(event)">
                <div class="card card-psi">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">Informations Personnelles</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Type de visa souhait√© *</label>
                                    <select class="form-select" name="type_visa" required>
                                        <option value="Touriste">Touriste</option>
                                        <option value="√âtudiant">√âtudiant</option>
                                        <option value="Affaires">Affaires</option>
                                        <option value="Immigration">Immigration</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Pays de destination *</label>
                                    <select class="form-select" name="pays_destination" required>
                                        <option value="Canada">Canada</option>
                                        <option value="France">France</option>
                                        <option value="USA">√âtats-Unis</option>
                                        <option value="Royaume-Uni">Royaume-Uni</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Nom *</label>
                                    <input type="text" class="form-control" name="nom" value="KOUAME" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Pr√©noms *</label>
                                    <input type="text" class="form-control" name="prenom" value="Jean" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Date de Naissance *</label>
                                    <input type="date" class="form-control" name="date_naissance" value="1990-05-15" required>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nationalit√© *</label>
                                    <input type="text" class="form-control" name="nationalite" value="Ivoirienne" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Sexe *</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="sexe" id="sexe_m" value="Masculin" checked>
                                            <label class="form-check-label" for="sexe_m">Masculin</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="sexe" id="sexe_f" value="F√©minin">
                                            <label class="form-check-label" for="sexe_f">F√©minin</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">√âtat civil *</label>
                                    <select class="form-select" name="etat_civil" required>
                                        <option value="C√©libataire">C√©libataire</option>
                                        <option value="Mari√©(e)">Mari√©(e)</option>
                                        <option value="Divorc√©(e)">Divorc√©(e)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Profession actuelle *</label>
                                    <input type="text" class="form-control" name="profession" value="Commercial" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Employeur / Entreprise</label>
                                    <input type="text" class="form-control" name="employeur" value="SARL Excellence">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card card-psi mt-4">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">Coordonn√©es</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Adresse compl√®te *</label>
                                    <textarea class="form-control" name="adresse" rows="2" required>Plateau, Abidjan, C√¥te d'Ivoire</textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Ville *</label>
                                    <input type="text" class="form-control" name="ville" value="Abidjan" required>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">T√©l√©phone mobile *</label>
                                    <input type="tel" class="form-control" name="telephone_mobile" value="+2250700000001" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Email *</label>
                                    <input type="email" class="form-control" name="email" value="jean.kouame@test.com" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-primary" onclick="afficherApercuFiche()">
                        <i class="bi bi-eye"></i> Aper√ßu de la Fiche
                    </button>
                    <div>
                        <button type="button" class="btn btn-secondary me-2" onclick="showSection('dashboard')">Annuler</button>
                        <button type="submit" class="btn btn-psi-primary">
                            <i class="bi bi-save"></i> Enregistrer la Fiche
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Aper√ßu Fiche d'Inscription -->
        <div id="apercu-fiche" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold" style="color: var(--psi-blue);">
                    <i class="bi bi-eye"></i> Aper√ßu de la Fiche d'Inscription
                </h2>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="showSection('nouvelle-fiche')">
                        <i class="bi bi-arrow-left"></i> Retour
                    </button>
                    <button class="btn btn-psi-primary" onclick="window.print()">
                        <i class="bi bi-printer"></i> Imprimer
                    </button>
                </div>
            </div>

            <div class="card card-psi">
                <div class="card-body pdf-preview" id="apercu-fiche-contenu">
                    <!-- Contenu g√©n√©r√© dynamiquement -->
                </div>
            </div>
        </div>

        <!-- Liste des Fiches d'Inscription -->
        <div id="liste-fiches" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold" style="color: var(--psi-blue);">
                    <i class="bi bi-people"></i> Gestion des Fiches d'Inscription
                </h2>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="showSection('dashboard')">
                        <i class="bi bi-arrow-left"></i> Retour
                    </button>
                    <button class="btn btn-psi-secondary" onclick="showSection('nouvelle-fiche')">
                        <i class="bi bi-person-plus"></i> Nouvelle Fiche
                    </button>
                </div>
            </div>

            <div class="card card-psi">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>N¬∞ Fiche</th>
                                    <th>Candidat</th>
                                    <th>Destination</th>
                                    <th>Type Visa</th>
                                    <th>Date Cr√©ation</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-fiches">
                                <!-- Rempli dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // VARIABLES GLOBALES ET INITIALISATION
        // ==========================================
        let contrats = [];
        let fiches = [];
        let currentContrat = null;
        let currentFiche = null;
        let signaturePad = null;

        // Configuration CSRF Token pour Laravel
        const csrfToken = '{{ csrf_token() }}';

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üöÄ PSI AFRICA - Syst√®me initialis√©");
            loadContratsFromDB();
            calculerMontants();
            calculerEcheances();
        });

        // ==========================================
        // FONCTIONS DE CHARGEMENT DEPUIS LA BDD
        // ==========================================
        async function loadContratsFromDB() {
            try {
                const response = await fetch('/crm/contrats', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Erreur lors du chargement des contrats');
                }

                const data = await response.json();

                if (data.success) {
                    // Adapter les donn√©es du backend au format attendu par le frontend
                    contrats = data.contracts.map(contract => ({
                        id: contract.id,
                        numero: contract.numero_contrat,
                        nom: contract.nom,
                        prenom: contract.prenom,
                        date_naissance: contract.date_naissance,
                        lieu_naissance: contract.lieu_naissance,
                        nationalite: contract.nationalite,
                        sexe: contract.sexe,
                        etat_civil: contract.etat_civil,
                        profession: contract.profession,
                        employeur: contract.employeur,
                        telephone: contract.telephone_mobile,
                        telephone_mobile: contract.telephone_mobile,
                        telephone_fixe: contract.telephone_fixe,
                        email: contract.email,
                        adresse: contract.adresse,
                        ville: contract.ville,
                        numero_cni: contract.numero_cni,
                        pays_destination: contract.pays_destination,
                        destination_visa: contract.pays_destination,
                        type_visa: contract.type_visa,
                        montant_total: parseFloat(contract.montant_contrat),
                        montant_contrat: parseFloat(contract.montant_contrat),
                        avance: parseFloat(contract.avance || 0),
                        reste_payer: parseFloat(contract.reste_payer || 0),
                        montant_lettres: contract.montant_lettres,
                        mode_paiement: contract.mode_paiement,
                        date_echeance: contract.date_echeance,
                        conseiller: contract.conseiller,
                        lieu_contrat: contract.lieu_contrat,
                        date_contrat: contract.date_contrat,
                        statut: contract.statut, // Garder le statut original: "Sign√©" ou "En attente"
                        signature: contract.signature,
                        signature_data: contract.signature,
                        nom_signataire: contract.nom_signataire,
                        date_signature: contract.date_signature,
                        signature_token: contract.signature_token,
                        signature_url: contract.signature_token ? `${window.location.origin}/signature/${contract.signature_token}` : null,
                        token_expires_at: contract.token_expires_at,
                        token_used_at: contract.token_used_at,
                        date_creation: contract.created_at,
                        observations: contract.observations
                    }));

                    console.log(`‚úÖ ${contrats.length} contrats charg√©s depuis la base de donn√©es`);
                    updateStats();
                    updateAuditLogs();
                    updateListeContrats();
                } else {
                    console.error('Erreur:', data.message);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des contrats:', error);
                alert('Erreur lors du chargement des contrats. Veuillez rafra√Æchir la page.');
            }
        }

        // ==========================================
        // FONCTIONS DE NAVIGATION
        // ==========================================
        function showSection(sectionId) {
            console.log("Navigation vers:", sectionId);
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active-section');
            });
            document.getElementById(sectionId).classList.add('active-section');

            // Recharger les donn√©es quand on va sur certaines sections
            if (sectionId === 'liste-contrats' || sectionId === 'dashboard') {
                loadContratsFromDB(); // Recharger pour voir les derni√®res modifications
            }

            if (sectionId === 'page-signature' && !signaturePad) {
                setTimeout(() => {
                    const canvas = document.getElementById('signature-pad');
                    if (canvas) {
                        signaturePad = new SignaturePad(canvas);
                        console.log("SignaturePad initialis√©");
                    }
                }, 100);
            }
        }

        // ==========================================
        // GESTION DES CONTRATS
        // ==========================================
        async function creerContrat(event) {
            event.preventDefault();
            console.log("Cr√©ation contrat...");

            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            const modePaiement = document.getElementById('mode-paiement-select').value;

            // Calculs financiers
            const montantTotal = parseInt(data.montant_total);
            let avance, reste_payer, echeances = [];

            if (modePaiement === 'totalite') {
                avance = montantTotal;
                reste_payer = 0;
                echeances = [{ montant: avance, date: data.date_contrat || new Date().toISOString().split('T')[0], type: 'Paiement total' }];
            } else if (modePaiement === 'avance-solde') {
                // Utiliser la valeur saisie dans le champ avance
                avance = parseInt(data.avance) || Math.round(montantTotal * 0.5);
                reste_payer = montantTotal - avance;
                const dateEcheance = new Date(data.date_contrat || new Date());
                dateEcheance.setDate(dateEcheance.getDate() + 45);

                echeances = [
                    { montant: avance, date: data.date_contrat || new Date().toISOString().split('T')[0], type: '1er versement', statut: 'pay√©' },
                    { montant: reste_payer, date: dateEcheance.toISOString().split('T')[0], type: '2√®me versement - Solde' }
                ];
            } else {
                // Autre mode de paiement
                avance = parseInt(data.avance) || 0;
                reste_payer = montantTotal - avance;
                echeances = [];
            }

            // Pr√©parer les donn√©es pour la BDD (format attendu par le backend)
            const contractData = {
                nom: data.nom,
                prenom: data.prenom,
                date_naissance: data.date_naissance,
                lieu_naissance: data.lieu_naissance || '',
                nationalite: 'Ivoirienne', // Valeur par d√©faut
                sexe: 'Masculin', // Valeur par d√©faut - √Ä am√©liorer avec un champ dans le formulaire
                etat_civil: 'C√©libataire', // Valeur par d√©faut - √Ä am√©liorer avec un champ dans le formulaire
                profession: data.profession,
                employeur: data.employeur || '',
                adresse: data.adresse,
                ville: 'Abidjan', // Valeur par d√©faut - √Ä am√©liorer avec un champ dans le formulaire
                telephone_mobile: data.telephone,
                telephone_fixe: '',
                email: data.email,
                type_visa: data.type_visa,
                pays_destination: data.destination_visa,
                montant_contrat: montantTotal,
                avance: avance,
                reste_payer: reste_payer,
                montant_lettres: nombreEnLettres(montantTotal),
                date_echeance: echeances.length > 1 ? echeances[1].date : null,
                mode_paiement: modePaiement,
                conseiller: data.conseiller,
                lieu_contrat: data.lieu_contrat,
                date_contrat: data.date_contrat || new Date().toISOString().split('T')[0],
                statut: 'En attente'
            };

            try {
                console.log('üì§ Envoi des donn√©es du contrat:', contractData);

                // Enregistrer dans la BDD
                const response = await fetch('/crm/contrats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(contractData)
                });

                console.log('üì• R√©ponse du serveur - Status:', response.status);

                const result = await response.json();
                console.log('üì• R√©ponse du serveur - Donn√©es:', result);

                if (!response.ok) {
                    // Afficher les erreurs de validation si disponibles
                    if (result.errors) {
                        const errorsText = Object.entries(result.errors)
                            .map(([field, messages]) => `${field}: ${messages.join(', ')}`)
                            .join('\n');
                        throw new Error('Erreur de validation:\n' + errorsText);
                    }
                    throw new Error(result.message || 'Erreur lors de la cr√©ation du contrat');
                }

                if (result.success) {
                    console.log("‚úÖ Contrat cr√©√© avec succ√®s:", result.contract);
                    console.log("üîó URL de signature:", result.signature_url);
                    console.log("‚è∞ Token expire le:", result.token_expires_at);

                    // Cr√©er l'objet contrat pour l'interface
                    const nouveauContrat = {
                        id: result.contract.id,
                        numero: result.contract.numero_contrat,
                        ...data,
                        montant_total: montantTotal,
                        montant_contrat: montantTotal,
                        avance: avance,
                        reste_payer: reste_payer,
                        mode_paiement: modePaiement,
                        echeances: echeances,
                        statut: result.contract.statut || 'En attente', // Utiliser le statut du backend
                        signature_token: result.contract.signature_token,
                        token_signature: result.contract.signature_token,
                        signature_url: result.signature_url,
                        token_expires_at: result.token_expires_at,
                        date_creation: result.contract.created_at,
                        date_expiration: result.token_expires_at,
                        signature: null,
                        signature_data: null,
                        date_signature: null,
                        nom_signataire: null
                    };

                    contrats.push(nouveauContrat);
                    currentContrat = nouveauContrat;

                    addAuditLog('creation_contrat', `Contrat ${nouveauContrat.numero} cr√©√©`);
                    showLienSignature(nouveauContrat, result.signature_url, result.token_expires_at);
                    updateStats();
                    updateListeContrats();

                    // Ne pas afficher d'alert ici, l'utilisateur verra directement le lien
                } else {
                    console.error('‚ùå Erreur:', result.message);
                    alert('Erreur lors de la cr√©ation du contrat: ' + (result.message || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la cr√©ation du contrat:', error);
                alert('Erreur lors de la cr√©ation du contrat:\n' + error.message);
            }
        }

        // Fonction pour convertir un nombre en lettres (simplifi√©e)
        function nombreEnLettres(nombre) {
            // Version simplifi√©e - √† am√©liorer si n√©cessaire
            return nombre.toLocaleString('fr-FR') + ' francs CFA';
        }

        function showLienSignature(contrat, signatureUrl, expiresAt) {
            // Utiliser l'URL de signature fournie par le serveur
            const lienSignature = signatureUrl || contrat.signature_url;
            const expiration = expiresAt || contrat.date_expiration;

            document.getElementById('lien-signature-input').value = lienSignature;
            document.getElementById('message-sms').textContent =
                `Bonjour ${contrat.prenom}, cliquez pour signer votre contrat PSI AFRICA : ${lienSignature}\n\n‚è∞ Lien valable jusqu'au ${expiration}\n\nCordialement,\nL'√©quipe PSI AFRICA`;

            showSection('lien-signature');
        }

        function afficherApercuContrat() {
            console.log("Affichage aper√ßu contrat");
            const formData = new FormData(document.getElementById('form-contrat'));
            const data = Object.fromEntries(formData);
            const apercuHTML = genererContratHTML(data);
            document.getElementById('apercu-contenu').innerHTML = apercuHTML;
            showSection('apercu-contrat');
        }

        function testSignature() {
            if (currentContrat) {
                document.getElementById('contrat-a-signer').innerHTML = genererContratHTML(currentContrat);
                document.getElementById('nom-signataire').value = currentContrat.prenom + ' ' + currentContrat.nom;
                showSection('page-signature');
            } else {
                alert("Veuillez d'abord cr√©er un contrat");
                showSection('nouveau-contrat');
            }
        }

        async function signerContrat() {
            if (!document.getElementById('acceptation').checked) {
                alert("Veuillez accepter les termes du contrat");
                return;
            }

            const nomSignataire = document.getElementById('nom-signataire').value;
            if (!nomSignataire.trim()) {
                alert("Veuillez saisir votre nom complet");
                return;
            }

            if (!signaturePad || signaturePad.isEmpty()) {
                alert("Veuillez apposer votre signature");
                return;
            }

            try {
                // Pr√©parer les donn√©es de signature
                const signatureData = {
                    signature: signaturePad.toDataURL(),
                    nom_signataire: nomSignataire
                };

                // Envoyer √† la BDD
                const response = await fetch(`/crm/contrats/${currentContrat.id}/sign`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(signatureData)
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la signature du contrat');
                }

                const result = await response.json();

                if (result.success) {
                    console.log("‚úÖ Contrat sign√© avec succ√®s:", result.contract);

                    // Mise √† jour du contrat local
                    const contratIndex = contrats.findIndex(c => c.id === currentContrat.id);
                    if (contratIndex !== -1) {
                        contrats[contratIndex].statut = 'signe';
                        contrats[contratIndex].date_signature = new Date().toISOString();
                        contrats[contratIndex].signature_data = signaturePad.toDataURL();
                        contrats[contratIndex].nom_signataire = nomSignataire;
                    }

                    addAuditLog('signature_contrat', `Contrat ${currentContrat.numero} sign√©`);

                    document.getElementById('confirmation-nom').textContent =
                        `F√©licitations ${currentContrat.prenom}, votre contrat a √©t√© sign√© avec succ√®s.`;
                    document.getElementById('lien-pdf-text').textContent =
                        `CONTRAT_${currentContrat.numero}_SIGNE.pdf`;

                    showSection('confirmation-signature');
                    updateStats();
                    updateListeContrats();

                    alert('‚úÖ Contrat sign√© avec succ√®s et enregistr√© dans la base de donn√©es!');
                } else {
                    console.error('Erreur:', result.message);
                    alert('Erreur lors de la signature du contrat: ' + (result.message || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur lors de la signature du contrat:', error);
                alert('Erreur lors de la signature du contrat. Veuillez r√©essayer.');
            }
        }

        function telechargerPDF() {
            alert("üìÑ PDF sign√© t√©l√©charg√© (simulation)");
        }

        // ==========================================
        // GESTION DES FICHES D'INSCRIPTION
        // ==========================================
        function creerFicheInscription(event) {
            event.preventDefault();
            console.log("Cr√©ation fiche...");
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            const nouvelleFiche = {
                id: Date.now(),
                numero: 'FICHE-' + new Date().getFullYear() + '-' + (fiches.length + 1).toString().padStart(4, '0'),
                ...data,
                date_creation: new Date().toISOString(),
                statut: 'complet'
            };
            
            fiches.push(nouvelleFiche);
            currentFiche = nouvelleFiche;

            addAuditLog('creation_fiche', `Fiche ${nouvelleFiche.numero} cr√©√©e`);
            alert("‚úÖ Fiche d'inscription cr√©√©e avec succ√®s !");
            showSection('dashboard');
            updateStats();
            updateListeFiches();
        }

        function afficherApercuFiche() {
            console.log("Affichage aper√ßu fiche");
            const formData = new FormData(document.getElementById('form-fiche'));
            const data = Object.fromEntries(formData);
            const apercuHTML = genererFicheHTML(data);
            document.getElementById('apercu-fiche-contenu').innerHTML = apercuHTML;
            showSection('apercu-fiche');
        }

        // ==========================================
        // GESTION FINANCI√àRE
        // ==========================================
        function toggleEchelonnage() {
            const mode = document.getElementById('mode-paiement-select').value;
            const sectionAvance = document.getElementById('section-avance-solde');
            const sectionEchelonnage = document.getElementById('section-echelonnage');
            
            if (mode === 'echelonnage') {
                sectionAvance.style.display = 'none';
                sectionEchelonnage.style.display = 'block';
            } else {
                sectionAvance.style.display = 'block';
                sectionEchelonnage.style.display = 'none';
            }
            calculerMontants();
        }

        function calculerMontants() {
            const montantTotal = parseInt(document.getElementById('montant-total').value) || 0;
            const mode = document.getElementById('mode-paiement-select').value;

            if (mode === 'totalite') {
                document.getElementById('avance-input').value = montantTotal;
                document.getElementById('reste-payer').value = '0 FCFA';
                document.getElementById('versement1').value = montantTotal.toLocaleString() + ' FCFA';
                document.getElementById('versement2').value = '0 FCFA';
            } else if (mode === 'avance-solde') {
                // Calculer le reste √† payer en fonction de l'avance saisie
                const avanceInput = document.getElementById('avance-input');
                let avance = parseInt(avanceInput.value) || 0;

                // Si l'avance n'est pas d√©finie, proposer 50% par d√©faut
                if (!avanceInput.value || avance === 0) {
                    avance = Math.round(montantTotal * 0.5);
                    avanceInput.value = avance;
                }

                const reste = montantTotal - avance;
                document.getElementById('reste-payer').value = reste.toLocaleString() + ' FCFA';
                document.getElementById('versement1').value = avance.toLocaleString() + ' FCFA';
                document.getElementById('versement2').value = reste.toLocaleString() + ' FCFA';
            } else {
                const moitie = Math.round(montantTotal * 0.5);
                document.getElementById('avance-input').value = moitie;
                document.getElementById('reste-payer').value = moitie.toLocaleString() + ' FCFA';
                document.getElementById('versement1').value = moitie.toLocaleString() + ' FCFA';
                document.getElementById('versement2').value = moitie.toLocaleString() + ' FCFA';
            }

            document.getElementById('montant-lettres').value = convertirMontantLettres(montantTotal);
            calculerEcheances();
        }

        function calculerEcheances() {
            const dateContrat = document.getElementById('date-contrat').value;
            if (!dateContrat) return;

            const date = new Date(dateContrat);
            const dateEcheance = new Date(date);
            dateEcheance.setDate(date.getDate() + 45);
            
            const dateStr = dateEcheance.toLocaleDateString('fr-FR');
            document.getElementById('date-echeance-solde').textContent = `√âch√©ance : ${dateStr}`;
            document.getElementById('date-echeance-echelonnage').textContent = `√âch√©ance : ${dateStr} (45 jours apr√®s signature)`;
        }

        function convertirMontantLettres(montant) {
            if (montant === 500000) return "Cinq cent mille francs CFA";
            if (montant === 250000) return "Deux cent cinquante mille francs CFA";
            return montant.toLocaleString() + " francs CFA";
        }

        // ==========================================
        // FONCTIONS UTILITAIRES
        // ==========================================
        function copierLien() {
            const input = document.getElementById('lien-signature-input');
            input.select();
            navigator.clipboard.writeText(input.value);
            alert("‚úÖ Lien copi√© !");
        }

        function effacerSignature() {
            if (signaturePad) signaturePad.clear();
        }

        function updateStats() {
            const totalContrats = contrats.length;
            const signes = contrats.filter(c => c.statut === 'Sign√©').length;
            const enAttente = contrats.filter(c => c.statut === 'En attente').length;
            const totalFiches = fiches.length;

            // Stats principales
            document.getElementById('stat-total').textContent = totalContrats;
            document.getElementById('stat-signes').textContent = signes;
            document.getElementById('stat-fiches').textContent = totalFiches;

            // Mini stats des Actions Rapides
            if (document.getElementById('quick-stat-total')) {
                document.getElementById('quick-stat-total').textContent = totalContrats;
                document.getElementById('quick-stat-signes').textContent = signes;
                document.getElementById('quick-stat-attente').textContent = enAttente;
            }

            const tauxSignature = totalContrats > 0 ? Math.round((signes / totalContrats) * 100) : 0;
            document.getElementById('taux-signature').textContent = tauxSignature + '%';
            document.getElementById('progress-signature').style.width = tauxSignature + '%';
        }

        function updateListeContrats() {
            const tbody = document.getElementById('table-contrats');
            const searchTerm = document.getElementById('search-contrats')?.value.toLowerCase() || '';
            const filterStatut = document.getElementById('filter-statut')?.value || 'tous';

            // Filtrer les contrats
            let contratsFiltered = contrats.filter(contrat => {
                const matchSearch = searchTerm === '' ||
                    contrat.numero.toLowerCase().includes(searchTerm) ||
                    contrat.nom.toLowerCase().includes(searchTerm) ||
                    contrat.prenom.toLowerCase().includes(searchTerm) ||
                    contrat.destination_visa.toLowerCase().includes(searchTerm);

                const matchStatut = filterStatut === 'tous' || contrat.statut === filterStatut;

                return matchSearch && matchStatut;
            });

            if (contratsFiltered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><i class="bi bi-inbox text-muted"></i><br>Aucun contrat trouv√©</td></tr>';
                document.getElementById('total-contrats-count').textContent = '0';
                return;
            }

            tbody.innerHTML = contratsFiltered.map(contrat => {
                const isExpired = contrat.token_expires_at && new Date(contrat.token_expires_at) < new Date();
                const isSigned = contrat.statut === 'Sign√©';

                return `
                <tr>
                    <td><strong>${contrat.numero}</strong></td>
                    <td>${contrat.prenom} ${contrat.nom}</td>
                    <td>${contrat.destination_visa}</td>
                    <td><strong>${contrat.montant_total.toLocaleString()} FCFA</strong></td>
                    <td>
                        ${isSigned ?
                            '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Sign√©</span>' :
                            isExpired ?
                                '<span class="badge bg-danger"><i class="bi bi-clock-history"></i> Lien expir√©</span>' :
                                '<span class="badge bg-warning"><i class="bi bi-hourglass-split"></i> En attente</span>'
                        }
                    </td>
                    <td>${new Date(contrat.date_creation).toLocaleDateString('fr-FR')}</td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                            <!-- Voir -->
                            <button class="btn btn-outline-primary" onclick="voirContrat(${contrat.id})" title="Voir le contrat">
                                <i class="bi bi-eye"></i>
                            </button>

                            <!-- Copier lien -->
                            ${!isSigned && !isExpired ? `
                                <button class="btn btn-outline-success" onclick="copierLienSignature('${contrat.signature_url}')" title="Copier le lien de signature">
                                    <i class="bi bi-link-45deg"></i>
                                </button>
                            ` : ''}

                            <!-- R√©g√©n√©rer lien si expir√© -->
                            ${!isSigned && isExpired ? `
                                <button class="btn btn-outline-warning" onclick="regenererLienSignature(${contrat.id})" title="R√©g√©n√©rer le lien de signature">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            ` : ''}

                            <!-- Imprimer -->
                            <button class="btn btn-outline-secondary" onclick="imprimerContrat(${contrat.id})" title="Imprimer le contrat">
                                <i class="bi bi-printer"></i>
                            </button>

                            <!-- Modifier (seulement si non sign√©) -->
                            ${!isSigned ? `
                                <button class="btn btn-outline-info" onclick="modifierContrat(${contrat.id})" title="Modifier le contrat">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            ` : ''}

                            <!-- Supprimer -->
                            <button class="btn btn-outline-danger" onclick="supprimerContrat(${contrat.id})" title="Supprimer le contrat">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');

            document.getElementById('total-contrats-count').textContent = contratsFiltered.length;
        }

        function updateListeFiches() {
            const tbody = document.getElementById('table-fiches');
            if (fiches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Aucune fiche</td></tr>';
                return;
            }
            
            tbody.innerHTML = fiches.map(fiche => `
                <tr>
                    <td>${fiche.numero}</td>
                    <td>${fiche.prenom} ${fiche.nom}</td>
                    <td>${fiche.pays_destination}</td>
                    <td>${fiche.type_visa}</td>
                    <td>${new Date(fiche.date_creation).toLocaleDateString('fr-FR')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="voirFiche(${fiche.id})">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function voirContrat(id) {
            const contrat = contrats.find(c => c.id === id);
            if (contrat) {
                document.getElementById('apercu-contenu').innerHTML = genererContratHTML(contrat);
                showSection('apercu-contrat');
            }
        }

        function voirFiche(id) {
            const fiche = fiches.find(f => f.id === id);
            if (fiche) {
                document.getElementById('apercu-fiche-contenu').innerHTML = genererFicheHTML(fiche);
                showSection('apercu-fiche');
            }
        }

        // ==========================================
        // NOUVELLES ACTIONS DE GESTION DES CONTRATS
        // ==========================================

        /**
         * Filtrer les contrats (int√©gr√© dans updateListeContrats)
         */
        function filterContrats() {
            updateListeContrats();
        }

        /**
         * R√©initialiser les filtres
         */
        function resetFilters() {
            document.getElementById('search-contrats').value = '';
            document.getElementById('filter-statut').value = 'tous';
            updateListeContrats();
        }

        /**
         * Copier le lien de signature
         */
        function copierLienSignature(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('‚úÖ Lien de signature copi√© dans le presse-papiers!\n\nVous pouvez maintenant le partager au client.');
            }).catch(err => {
                // Fallback pour les anciens navigateurs
                const textarea = document.createElement('textarea');
                textarea.value = url;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('‚úÖ Lien de signature copi√©!');
            });
        }

        /**
         * R√©g√©n√©rer le lien de signature (si expir√©)
         */
        async function regenererLienSignature(contractId) {
            if (!confirm('Voulez-vous r√©g√©n√©rer un nouveau lien de signature pour ce contrat ?')) {
                return;
            }

            try {
                const response = await fetch(`/crm/contrats/${contractId}/regenerate-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                        'Accept': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // Mettre √† jour le contrat dans le tableau local
                    const contrat = contrats.find(c => c.id === contractId);
                    if (contrat) {
                        contrat.signature_url = result.signature_url;
                        contrat.token_expires_at = result.token_expires_at;
                    }

                    updateListeContrats();

                    alert(`‚úÖ Nouveau lien g√©n√©r√© avec succ√®s!\n\nLien valable jusqu'au ${result.token_expires_at}`);

                    // Afficher le lien
                    copierLienSignature(result.signature_url);
                } else {
                    alert('‚ùå Erreur: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur r√©g√©n√©ration token:', error);
                alert('‚ùå Erreur lors de la r√©g√©n√©ration du lien.');
            }
        }

        /**
         * Imprimer un contrat
         */
        function imprimerContrat(id) {
            const contrat = contrats.find(c => c.id === id);
            if (!contrat) return;

            // G√©n√©rer le HTML du contrat
            const contratHTML = genererContratHTML(contrat);

            // Cr√©er une nouvelle fen√™tre pour l'impression
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Contrat ${contrat.numero}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        @media print {
                            body { margin: 0; padding: 20px; }
                            .no-print { display: none; }
                        }
                        body { font-family: Arial, sans-serif; }
                    </style>
                </head>
                <body>
                    ${contratHTML}
                    <script>
                        window.onload = function() {
                            window.print();
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        /**
         * Modifier un contrat
         */
        function modifierContrat(id) {
            const contrat = contrats.find(c => c.id === id);
            if (!contrat) return;

            if (contrat.statut === 'Sign√©') {
                alert('‚ö†Ô∏è Ce contrat est d√©j√† sign√© et ne peut plus √™tre modifi√©.');
                return;
            }

            // Remplir le formulaire avec les donn√©es existantes
            document.querySelector('[name="nom"]').value = contrat.nom;
            document.querySelector('[name="prenom"]').value = contrat.prenom;
            document.querySelector('[name="date_naissance"]').value = contrat.date_naissance;
            document.querySelector('[name="lieu_naissance"]').value = contrat.lieu_naissance;
            document.querySelector('[name="profession"]').value = contrat.profession;
            document.querySelector('[name="telephone"]').value = contrat.telephone_mobile;
            document.querySelector('[name="email"]').value = contrat.email;
            document.querySelector('[name="numero_cni"]').value = contrat.numero_cni || '';
            document.querySelector('[name="adresse"]').value = contrat.adresse;
            document.querySelector('[name="destination_visa"]').value = contrat.pays_destination;
            document.querySelector('[name="type_visa"]').value = contrat.type_visa;
            document.querySelector('[name="montant_total"]').value = contrat.montant_total;
            document.querySelector('[name="mode_paiement"]').value = contrat.mode_paiement;
            document.querySelector('[name="conseiller"]').value = contrat.conseiller;
            document.querySelector('[name="lieu_contrat"]').value = contrat.lieu_contrat;
            document.querySelector('[name="date_contrat"]').value = contrat.date_contrat;
            document.querySelector('[name="observations"]').value = contrat.observations || '';

            // Stocker l'ID pour la mise √† jour
            currentContrat = contrat;

            // Afficher le formulaire
            showSection('nouveau-contrat');

            alert('‚ÑπÔ∏è Vous pouvez maintenant modifier le contrat. Cliquez sur "Valider" pour enregistrer les modifications.');
        }

        /**
         * Supprimer un contrat
         */
        async function supprimerContrat(id) {
            const contrat = contrats.find(c => c.id === id);
            if (!contrat) return;

            if (!confirm(`‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer le contrat ${contrat.numero} ?\n\nCette action est irr√©versible.`)) {
                return;
            }

            try {
                const response = await fetch(`/crm/contrats/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                        'Accept': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // Retirer du tableau local
                    contrats = contrats.filter(c => c.id !== id);

                    updateStats();
                    updateListeContrats();

                    addAuditLog('Contrat supprim√©', `Contrat ${contrat.numero} supprim√©`);
                    alert('‚úÖ Contrat supprim√© avec succ√®s.');
                } else {
                    alert('‚ùå Erreur: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur suppression contrat:', error);
                alert('‚ùå Erreur lors de la suppression du contrat.');
            }
        }

        // ==========================================
        // GESTION DES LOGS D'AUDIT
        // ==========================================
        let auditLogs = []; // Stockage en m√©moire des logs de session

        function updateAuditLogs() {
            const container = document.getElementById('audit-logs');

            if (auditLogs.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-inbox"></i><br>Aucune activit√© r√©cente</div>';
                return;
            }

            container.innerHTML = auditLogs.slice(-5).reverse().map(log => `
                <div class="audit-log">
                    <div class="d-flex justify-content-between">
                        <strong>${log.action}</strong>
                        <small>${new Date(log.timestamp).toLocaleString()}</small>
                    </div>
                    <div class="text-muted">${log.details}</div>
                </div>
            `).join('');
        }

        function addAuditLog(action, details) {
            auditLogs.push({ action, details, timestamp: new Date().toISOString() });
            updateAuditLogs();
        }

        function resetSystem() {
            if (confirm("Voulez-vous vraiment recharger les donn√©es depuis la base de donn√©es ?")) {
                contrats = [];
                fiches = [];
                auditLogs = [];
                loadContratsFromDB(); // Recharge depuis la BDD
                alert("‚úÖ Donn√©es recharg√©es depuis la base de donn√©es");
            }
        }

        // ==========================================
        // G√âN√âRATION HTML AVEC VRAIS MOD√àLES
        // ==========================================
        function genererContratHTML(data) {
            // Article 3 : Toujours afficher les modalit√©s de paiement
            const montantTotal = parseInt(data.montant_total || data.montant_contrat || 0);
            const avance = parseInt(data.avance || 0);
            const restePayer = parseInt(data.reste_payer || (montantTotal - avance));

            let conditionsPaiement = `
                <div class="contrat-article">
                    <h4>Article 3 : Modalit√©s financi√®res</h4>
                    <p>Les frais dus √† <strong>CCE</strong> comprennent deux cat√©gories :</p>
                    <ul>
                        <li><strong>Frais de cabinet</strong> : couvrant le conseil, le suivi et la gestion du dossier ;</li>
                        <li><strong>Frais d'assistance et d'inscription</strong>, le cas √©ch√©ant.</li>
                    </ul>

                    <h5>3.1 Montant et conditions de paiement</h5>
                    <p><strong>Montant total des frais :</strong> ${montantTotal.toLocaleString()} FCFA</p>
                    ${data.montant_lettres ? `<p><em>(${data.montant_lettres})</em></p>` : ''}

                    ${avance > 0 ? `
                        <p><strong>‚úÖ Avance vers√©e :</strong> <span style="color: #28a745; font-weight: bold;">${avance.toLocaleString()} FCFA</span></p>
                    ` : ''}

                    ${restePayer > 0 ? `
                        <p><strong>‚è≥ Reste √† payer :</strong> <span style="color: #dc3545; font-weight: bold;">${restePayer.toLocaleString()} FCFA</span></p>
                    ` : ''}

                    ${data.mode_paiement ? `
                        <p><strong>Mode de paiement :</strong> ${data.mode_paiement}</p>
                    ` : ''}

                    ${data.echeances && data.echeances.length > 0 ? `
                        <h5 style="margin-top: 15px;">3.2 √âch√©ancier de paiement</h5>
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Description</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Montant</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Date</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.echeances.map((echeance, index) => `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${echeance.type || ('Versement ' + (index + 1))}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${parseInt(echeance.montant).toLocaleString()} FCFA</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${new Date(echeance.date).toLocaleDateString('fr-FR')}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                            ${echeance.statut === 'pay√©' || index === 0 ? '‚úÖ Vers√©' : '‚è≥ √Ä venir'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}

                    <p style="margin-top: 15px;"><strong>Clause importante :</strong> Tout retard de paiement sup√©rieur √† 10 jours entra√Æne une <strong>suspension du suivi du dossier</strong> jusqu'√† r√©gularisation compl√®te.</p>
                </div>
            `;

            return `
                <div class="contrat-content">
                    <div style="text-align: center; border-bottom: 2px solid #0A2463; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="color: #0A2463; margin-bottom: 5px;">CABINET CONSEILLER EXPERT (CCE)</h1>
                        <h2 style="color: #D4AF37; margin-bottom: 10px;">CONTRAT D'ASSISTANCE ET DE CONSEIL EN PROC√âDURE DE VISA</h2>
                        <p style="color: #666;">Cabinet de conseil sp√©cialis√© en immigration l√©gale</p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <p><strong>Entre les soussign√©s :</strong></p>
                        <p><strong>CABINET CONSEILLER EXPERT (CCE)</strong>, Cabinet de conseil sp√©cialis√© en immigration l√©gale, immatricul√© en C√¥te d'Ivoire,</p>
                        <p>ci-apr√®s d√©sign√© <em>¬´ le Cabinet ¬ª</em> ou <em>¬´ CCE ¬ª</em>,</p>
                        
                        <p><strong>Et :</strong></p>
                        <p><strong>M./Mme : ${data.prenom} ${data.nom}</strong></p>
                        <p>N√©(e) le : ${new Date(data.date_naissance).toLocaleDateString('fr-FR')}</p>
                        <p>Profession : ${data.profession || 'Non renseign√©'}</p>
                        <p>T√©l√©phone : ${data.telephone}</p>
                        <p>Adresse e-mail : ${data.email}</p>
                        <p>ci-apr√®s d√©sign√© <em>¬´ le Client ¬ª</em>.</p>
                        
                        <p>Les deux parties, ci-apr√®s d√©sign√©es collectivement <em>¬´ les Parties ¬ª</em>, ont convenu de ce qui suit :</p>
                    </div>

                    <div class="contrat-article">
                        <h4>Article 1 : Objet du contrat</h4>
                        <p>Le pr√©sent contrat a pour objet de d√©finir les conditions dans lesquelles <strong>CCE</strong> assure au Client :</p>
                        <ul>
                            <li>Une <strong>assistance administrative, documentaire et logistique</strong> dans le cadre de sa <strong>demande de visa</strong> ;</li>
                            <li>Un <strong>accompagnement personnalis√©</strong> pour la constitution du dossier, la prise de rendez-vous, la pr√©paration √† l'entretien et le suivi de la proc√©dure jusqu'√† d√©cision finale.</li>
                        </ul>
                        <p><strong>CCE</strong> agit uniquement comme <strong>cabinet de conseil et d'assistance</strong> et <strong>n'intervient pas dans la d√©cision d'obtention du visa</strong>, celle-ci relevant exclusivement des autorit√©s consulaires.</p>
                    </div>

                    <div class="contrat-article">
                        <h4>Article 2 : Nature des prestations</h4>
                        <p>Les prestations fournies par le Cabinet comprennent notamment :</p>
                        <ol>
                            <li>L'√©tude du profil du Client et la d√©finition du type de visa appropri√© ;</li>
                            <li>L'assistance pour la constitution du dossier (formulaires, pi√®ces, justificatifs, traduction) ;</li>
                            <li>La pr√©paration √† l'entretien consulaire (simulation, coaching, conseils personnalis√©s) ;</li>
                            <li>La prise de rendez-vous et le suivi administratif de la demande ;</li>
                            <li>Le conseil g√©n√©ral sur les d√©marches li√©es au voyage (h√©bergement, assurance, billet d'avion, etc.).</li>
                        </ol>
                        <p>Toute prestation non mentionn√©e dans la liste ci-dessus fera l'objet d'un <strong>avenant</strong> ou d'un <strong>devis s√©par√©</strong>.</p>
                    </div>

                    ${conditionsPaiement}

                    <div class="contrat-article">
                        <h4>Article 4 : Clause de non-remboursement</h4>
                        <p>Les frais vers√©s √† <strong>CCE</strong> sont <strong>strictement non remboursables</strong>, pour les raisons suivantes :</p>
                        <ul>
                            <li>Les prestations de conseil et d'assistance sont consid√©r√©es comme <strong>d√©marr√©es d√®s l'ouverture du dossier</strong> ;</li>
                            <li>Le Cabinet engage des ressources humaines, mat√©rielles et administratives d√®s la signature du contrat ;</li>
                            <li>Le r√©sultat final (d√©livrance du visa) d√©pend <strong>exclusivement de la d√©cision consulaire</strong>, ind√©pendante du Cabinet.</li>
                        </ul>
                        <p>Aucun remboursement ne sera accord√© en cas :</p>
                        <ul>
                            <li>De refus de visa par les autorit√©s consulaires ;</li>
                            <li>De retrait du dossier par le Client ;</li>
                            <li>De fourniture tardive, incompl√®te ou erron√©e des documents par le Client ;</li>
                            <li>De non-respect du calendrier ou des consignes donn√©es par le Cabinet.</li>
                        </ul>
                    </div>

                    <div class="contrat-article">
                        <h4>Article 5 : Obligations du Cabinet</h4>
                        <p><strong>CCE</strong> s'engage √† :</p>
                        <ul>
                            <li>Fournir des conseils exacts, actualis√©s et conformes aux proc√©dures consulaires en vigueur ;</li>
                            <li>Assister le Client de mani√®re professionnelle, transparente et confidentielle ;</li>
                            <li>Respecter les d√©lais convenus dans la mesure o√π le Client fournit les √©l√©ments demand√©s en temps utile.</li>
                        </ul>
                        <p>Le Cabinet ne saurait √™tre tenu responsable :</p>
                        <ul>
                            <li>Des d√©cisions des ambassades, consulats ou services d'immigration ;</li>
                            <li>Des retards administratifs ou modifications de proc√©dures ;</li>
                            <li>Des pertes ou rejets de documents imputables au Client ou aux autorit√©s.</li>
                        </ul>
                    </div>

                    <div class="contrat-article">
                        <h4>Article 6 : Obligations du Client</h4>
                        <p>Le Client s'engage √† :</p>
                        <ul>
                            <li>Fournir des informations exactes et v√©ridiques ;</li>
                            <li>Respecter les d√©lais de remise des documents demand√©s ;</li>
                            <li>R√©gler les frais dus dans les conditions pr√©vues √† l'article 3 ;</li>
                            <li>Suivre les conseils du Cabinet et ne pas engager de d√©marches parall√®les sans en informer <strong>CCE</strong>.</li>
                        </ul>
                        <p>Toute fausse d√©claration, omission ou comportement frauduleux entra√Ænera la <strong>r√©siliation automatique</strong> du contrat sans remboursement possible.</p>
                    </div>

                    <div class="contrat-article">
                        <h4>Article 7 : Confidentialit√© et protection des donn√©es</h4>
                        <p><strong>CCE</strong> s'engage √† prot√©ger la confidentialit√© de toutes les informations fournies par le Client et √† ne les utiliser que dans le cadre strict de la prestation d'assistance.</p>
                        <p>Aucune donn√©e ne sera transmise √† un tiers sans l'accord √©crit du Client.</p>
                    </div>

                    <div class="contrat-article">
                        <h4>Article 8 : Dur√©e du contrat</h4>
                        <p>Le pr√©sent contrat prend effet √† la date de signature et reste valable <strong>jusqu'√† la fin de la proc√©dure engag√©e</strong>.</p>
                        <p>Il prend automatiquement fin :</p>
                        <ul>
                            <li>√Ä la d√©livrance du visa ;</li>
                            <li>Ou √† la r√©ception d'une d√©cision de refus ;</li>
                            <li>Ou en cas de r√©siliation motiv√©e par une faute grave du Client.</li>
                        </ul>
                    </div>

                    <div class="contrat-article">
                        <h4>Article 9 : R√©siliation</h4>
                        <p>En cas de manquement grave par l'une des Parties √† ses obligations contractuelles, le contrat pourra √™tre r√©sili√© de plein droit apr√®s <strong>mise en demeure rest√©e sans effet pendant 7 jours</strong>.</p>
                        <p>Aucune somme d√©j√† vers√©e ne sera rembours√©e.</p>
                    </div>

                    <div class="contrat-article">
                        <h4>Article 10 : Clause de non-garantie de r√©sultat</h4>
                        <p>Le Cabinet s'engage √† <strong>mettre en ≈ìuvre tous les moyens possibles</strong> pour l'aboutissement du dossier, sans pour autant garantir l'obtention du visa.</p>
                        <p>Le Client reconna√Æt avoir compris que <strong>le r√©sultat d√©pend de la d√©cision souveraine des autorit√©s consulaires.</strong></p>
                    </div>

                    <div class="contrat-article">
                        <h4>Article 11 : Juridiction comp√©tente</h4>
                        <p>En cas de litige, les Parties s'engagent d'abord √† rechercher une solution amiable.</p>
                        <p>√Ä d√©faut, comp√©tence expresse est attribu√©e aux tribunaux du ressort du <strong>si√®ge social du Cabinet Conseiller Expert (CCE)</strong>.</p>
                    </div>

                    <div class="contrat-article">
                        <h4>Article 12 : Acceptation</h4>
                        <p>Le Client d√©clare avoir lu, compris et accept√© sans r√©serve les termes du pr√©sent contrat, ainsi que les <strong>conditions g√©n√©rales d'assistance du Cabinet Conseiller Expert (CCE)</strong> annex√©es au document.</p>
                    </div>

                    <div style="margin-top: 50px; border-top: 1px solid #000; padding-top: 20px;">
                        <table style="width: 100%;">
                            <tr>
                                <td style="width: 50%; vertical-align: top; text-align: center;">
                                    <strong>Le Client</strong><br><br>
                                    ${data.prenom} ${data.nom}<br><br>
                                    ${data.signature ? `
                                        <div style="margin: 10px 0;">
                                            <img src="${data.signature}" alt="Signature" style="max-width: 500px; border: 0px solid #ddd; padding: 40px; background: white;">
                                        </div>
                                        <p style="margin-top: 5px; font-size: 0.9em; color: #666;">
                                            Sign√© le ${data.date_signature ? new Date(data.date_signature).toLocaleString('fr-FR') : ''}
                                            ${data.nom_signataire ? '<br>Par: ' + data.nom_signataire : ''}
                                        </p>
                                    ` : `
                                        _________________________<br>
                                        <em>Signature pr√©c√©d√©e de la mention ¬´ Lu et approuv√© ¬ª</em>
                                    `}
                                </td>
                                <td style="width: 50%; vertical-align: top; text-align: center;">
                                    <strong>CABINET CONSEILLER EXPERT (CCE)</strong><br><br>
                                    ${data.conseiller || 'Le Responsable'}<br><br>
                                    <div style="margin: 10px 0;">
                                        <img src="/img/cachet-cce.jpg" alt="Cachet CCE" style="max-width: 180px; height: auto;">
                                    </div>
                                    <em style="font-size: 0.85em; color: #666;">Cachet et signature du Cabinet</em>
                                </td>
                            </tr>
                        </table>

                        <div style="text-align: center; margin-top: 30px;">
                            <p><strong>Fait √† ${data.lieu_contrat || 'Abidjan'}, le ${data.date_contrat}</strong></p>
                            <p>En deux exemplaires originaux.</p>
                        </div>
                    </div>

                    <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">
                        <p><strong>Mention l√©gale :</strong> Document officiel g√©n√©r√© √©lectroniquement - Toute modification rend ce document nul.</p>
                        <p>Contrat g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}</p>
                    </div>
                </div>
            `;
        }

        function genererFicheHTML(data) {
            return `
                <div class="contrat-content">
                    <div style="text-align: center; border-bottom: 2px solid #0A2463; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="color: #0A2463; margin-bottom: 5px;">CABINET CONSEILLER EXPERT (CCE)</h1>
                        <h2 style="color: #D4AF37; margin-bottom: 10px;">BULLETIN INDIVIDUEL D'INSCRIPTION</h2>
                        <p style="color: #666;">(√Ä remplir en lettres majuscules -- Une case par lettre ou chiffre)</p>
                        <p><strong>N¬∞ Fiche: ${data.numero || 'FICHE-' + new Date().getFullYear() + '-001'}</strong></p>
                    </div>

                    <div class="contrat-article">
                        <h4>üßæ 1. Informations personnelles</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px; width: 30%;"><strong>Type de visa souhait√©</strong></td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><div class="fiche-field">${data.type_visa}</div></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;"><strong>Pays de destination</strong></td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><div class="fiche-field">${data.pays_destination}</div></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;"><strong>Nom</strong></td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><div class="fiche-field">${data.nom}</div></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;"><strong>Pr√©noms</strong></td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><div class="fiche-field">${data.prenom}</div></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;"><strong>Date et lieu de naissance</strong></td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><div class="fiche-field">${new Date(data.date_naissance).toLocaleDateString('fr-FR')} √† ${data.lieu_naissance || ''}</div></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;"><strong>Nationalit√©</strong></td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><div class="fiche-field">${data.nationalite}</div></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;"><strong>Sexe</strong></td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><div class="fiche-field">${data.sexe}</div></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;"><strong>√âtat civil</strong></td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><div class="fiche-field">${data.etat_civil}</div></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;"><strong>Profession actuelle</strong></td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><div class="fiche-field">${data.profession}</div></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;"><strong>Employeur / Entreprise</strong></td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><div class="fiche-field">${data.employeur || ''}</div></td>
                            </tr>
                        </table>
                    </div>

                    <div class="contrat-article">
                        <h4>üè† 2. Coordonn√©es</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px; width: 30%;"><strong>Adresse compl√®te</strong></td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><div class="fiche-field">${data.adresse}</div></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;"><strong>Ville / Commune</strong></td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><div class="fiche-field">${data.ville}</div></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;"><strong>T√©l√©phone mobile</strong></td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><div class="fiche-field">${data.telephone_mobile}</div></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;"><strong>Adresse e-mail</strong></td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><div class="fiche-field">${data.email}</div></td>
                            </tr>
                        </table>
                    </div>

                    <div class="contrat-article">
                        <h4>‚úçÔ∏è 7. Engagement du candidat</h4>
                        <p>Je soussign√©(e) <strong>${data.prenom} ${data.nom}</strong>,</p>
                        <p>certifie sur l'honneur que les informations fournies sont exactes et sinc√®res.</p>
                        <p>Je d√©clare avoir pris connaissance des <strong>conditions g√©n√©rales et financi√®res</strong> du <strong>Cabinet Conseiller Expert (CCE)</strong> et les accepter sans r√©serve.</p>
                        
                        <div style="margin-top: 50px;">
                            <div style="float: left; width: 45%;">
                                <p>Fait √† : <strong>${data.ville}</strong></p>
                                <p>Le : <strong>${new Date().toLocaleDateString('fr-FR')}</strong></p>
                            </div>
                            <div style="float: right; width: 45%; text-align: center;">
                                <p>Signature du candidat :</p>
                                <div style="margin-top: 60px; border-top: 1px solid #000; width: 80%; margin-left: auto; margin-right: auto;"></div>
                                <p><em>${data.prenom} ${data.nom}</em></p>
                            </div>
                            <div style="clear: both;"></div>
                        </div>
                    </div>

                    <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">
                        <p><strong>CABINET CONSEILLER EXPERT (CCE) - Cabinet de conseil sp√©cialis√© en immigration l√©gale</strong></p>
                        <p>Abidjan, Plateau | T√©l: +225 27 20 00 00 00 | Email: contact@cce.com</p>
                        <p>Fiche g√©n√©r√©e le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}</p>
                    </div>
                </div>
            `;
        }

        // ==================== JAVASCRIPT POUR CONTRATS AVEC BASE DE DONN√âES ====================
// Remplacer les fonctions localStorage dans contrats.blade.php par ces nouvelles fonctions

// Configuration AJAX avec CSRF token
$.ajaxSetup({
    headers: {
        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
    }
});

// ========== FONCTIONS DE GESTION DES CONTRATS ==========

/**
 * Charger tous les contrats depuis la base de donn√©es
 */
async function chargerContrats() {
    try {
        const response = await fetch('/crm/contrats/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            return data.contracts || [];
        } else {
            console.error('Erreur:', data.message);
            return [];
        }
    } catch (error) {
        console.error('Erreur chargement contrats:', error);
        showToast('Erreur lors du chargement des contrats', 'error');
        return [];
    }
}

/**
 * Sauvegarder un nouveau contrat
 */
async function sauvegarderContrat(contratData) {
    try {
        const response = await fetch('/crm/contrats/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify(contratData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Contrat cr√©√© avec succ√®s', 'success');
            return data.contract;
        } else {
            showToast(data.message || 'Erreur lors de la cr√©ation du contrat', 'error');
            if (data.errors) {
                console.error('Erreurs de validation:', data.errors);
            }
            return null;
        }
    } catch (error) {
        console.error('Erreur sauvegarde contrat:', error);
        showToast('Erreur lors de la sauvegarde du contrat', 'error');
        return null;
    }
}

/**
 * Signer un contrat
 */
async function signerContratDB(contractId, signature, nomSignataire) {
    try {
        const response = await fetch(`/crm/contrats/${contractId}/sign`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                signature: signature,
                nom_signataire: nomSignataire
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Contrat sign√© avec succ√®s', 'success');
            return data.contract;
        } else {
            showToast(data.message || 'Erreur lors de la signature', 'error');
            return null;
        }
    } catch (error) {
        console.error('Erreur signature contrat:', error);
        showToast('Erreur lors de la signature du contrat', 'error');
        return null;
    }
}

/**
 * Charger les statistiques
 */
async function chargerStatistiques() {
    try {
        const response = await fetch('/crm/contrats/stats/dashboard', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            return data.stats;
        } else {
            console.error('Erreur:', data.message);
            return null;
        }
    } catch (error) {
        console.error('Erreur chargement statistiques:', error);
        return null;
    }
}

/**
 * Charger le dashboard des contrats
 */
async function chargerDashboard() {
    const stats = await chargerStatistiques();
    const contrats = await chargerContrats();
    
    if (!stats) {
        document.getElementById('dashboard-stats').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Erreur lors du chargement des statistiques
            </div>
        `;
        return;
    }
    
    // Afficher les statistiques
    document.getElementById('dashboard-stats').innerHTML = `
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card-contrat" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h3 class="stat-number-contrat">${stats.total}</h3>
                    <p class="mb-0">Total Contrats</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card-contrat" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3 class="stat-number-contrat">${stats.signed}</h3>
                    <p class="mb-0">Contrats Sign√©s</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card-contrat" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h3 class="stat-number-contrat">${stats.pending}</h3>
                    <p class="mb-0">En Attente</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card-contrat" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <h3 class="stat-number-contrat">${stats.signature_rate}%</h3>
                    <p class="mb-0">Taux de Signature</p>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <strong><i class="bi bi-info-circle"></i> Statistiques :</strong>
                    ${stats.this_month} contrats ce mois | 
                    ${stats.this_year} contrats cette ann√©e | 
                    Montant total : ${new Intl.NumberFormat('fr-FR').format(stats.total_amount)} FCFA
                </div>
            </div>
        </div>
    `;
    
    // Afficher les contrats r√©cents
    afficherContratsRecents(contrats);
}

/**
 * Afficher les contrats r√©cents
 */
function afficherContratsRecents(contrats) {
    const container = document.getElementById('contrats-list');
    
    if (!contrats || contrats.length === 0) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-inbox"></i>
                Aucun contrat pour le moment
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>N¬∞ Contrat</th>
                        <th>Client</th>
                        <th>Type Visa</th>
                        <th>Pays</th>
                        <th>Montant</th>
                        <th>Date</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    contrats.forEach(contrat => {
        const statusClass = contrat.statut === 'Sign√©' ? 'success' : 
                           contrat.statut === 'En attente' ? 'warning' : 'danger';
        const statusIcon = contrat.statut === 'Sign√©' ? '‚úÖ' : 
                          contrat.statut === 'En attente' ? '‚è≥' : '‚ùå';
        
        html += `
            <tr>
                <td><strong>${contrat.numero_contrat}</strong></td>
                <td>${contrat.prenom} ${contrat.nom}</td>
                <td>${contrat.type_visa}</td>
                <td>${contrat.pays_destination}</td>
                <td>${new Intl.NumberFormat('fr-FR').format(contrat.montant_contrat)} F</td>
                <td>${new Date(contrat.date_contrat).toLocaleDateString('fr-FR')}</td>
                <td><span class="badge bg-${statusClass}">${statusIcon} ${contrat.statut}</span></td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="voirContrat(${contrat.id})">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="telechargerPDFContrat(${contrat.id})">
                        <i class="bi bi-download"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="supprimerContrat(${contrat.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

/**
 * Fonction Toast pour les notifications
 */
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show`;
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
    document.body.appendChild(container);
    return container;
}

// ========== REMPLACER LA FONCTION genererContrat ORIGINALE ==========
async function genererContrat() {
    const form = document.getElementById('form-contrat');
    const formData = new FormData(form);
    
    // Convertir FormData en objet
    const contratData = {
        nom: formData.get('nom'),
        prenom: formData.get('prenom'),
        date_naissance: formData.get('date_naissance'),
        lieu_naissance: formData.get('lieu_naissance') || '',
        nationalite: formData.get('nationalite'),
        sexe: formData.get('sexe'),
        etat_civil: formData.get('etat_civil'),
        profession: formData.get('profession'),
        employeur: formData.get('employeur') || '',
        adresse: formData.get('adresse'),
        ville: formData.get('ville'),
        telephone_mobile: formData.get('telephone_mobile'),
        telephone_fixe: formData.get('telephone_fixe') || '',
        email: formData.get('email'),
        type_visa: formData.get('type_visa'),
        pays_destination: formData.get('pays_destination'),
        montant_contrat: parseFloat(formData.get('montant_contrat')),
        montant_lettres: formData.get('montant_lettres'),
        date_echeance: formData.get('date_echeance') || null,
        mode_paiement: formData.get('mode_paiement') || '',
        conseiller: formData.get('conseiller') || '',
        lieu_contrat: formData.get('lieu_contrat') || 'Abidjan',
        date_contrat: formData.get('date_contrat'),
        statut: 'En attente'
    };
    
    // Sauvegarder dans la base de donn√©es
    const savedContract = await sauvegarderContrat(contratData);
    
    if (savedContract) {
        // Stocker l'ID du contrat pour la signature
        window.currentContractId = savedContract.id;
        
        // Afficher la pr√©visualisation
        afficherContrat(savedContract);
    }
}

// ========== REMPLACER LA FONCTION signerContrat ORIGINALE ==========
async function signerContrat() {
    const acceptation = document.getElementById('acceptation');
    const nomSignataire = document.getElementById('nom-signataire').value;
    
    if (!acceptation.checked) {
        alert('Vous devez accepter les termes du contrat');
        return;
    }
    
    if (!nomSignataire) {
        alert('Veuillez saisir votre nom complet');
        return;
    }
    
    if (signaturePad.isEmpty()) {
        alert('Veuillez signer le document');
        return;
    }
    
    const signature = signaturePad.toDataURL();
    
    // Signer le contrat dans la base de donn√©es
    const signedContract = await signerContratDB(window.currentContractId, signature, nomSignataire);
    
    if (signedContract) {
        alert('‚úÖ Contrat sign√© avec succ√®s !');
        showSection('dashboard');
        await chargerDashboard();
    }
}

// ========== INITIALISATION AU CHARGEMENT ==========
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('contrats-panel')) {
        chargerDashboard();
    }
});
    </script>
</body>
</html>